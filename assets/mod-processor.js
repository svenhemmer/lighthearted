const BinUtils={readAscii(t,e,s=0){const i=new Uint8Array(t);let a="",o=!1;for(let t=0;!o;++t){const e=i[s+t];o=0===e,o||(a+=String.fromCharCode(e))}return a},readWord:(t,e=0,s=!1)=>new DataView(t).getUint16(e,s)},PaulaPeriods=new Float32Array([856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113]),waveForms=new Array(4);waveForms[0]=new Float32Array(64);for(let t=0;t<waveForms[0].length;++t)waveForms[0][t]=64*Math.sin(2*Math.PI*(t/64));class PTModuleProcessor extends AudioWorkletProcessor{constructor(){super(),this.port.onmessage=this.handleMessage.bind(this),this.patternLength=1024}handleMessage(t){switch(t.data.message){case"init":this.mixingRate=t.data.mixingRate,this.audioWorkletSupport=t.data.audioWorkletSupport;break;case"loadModule":this.prepareModule(t.data.buffer);break;case"setPlay":this.ready&&(this.playing=t.data.playing);break;case"reset":this.ready&&this.resetValues();break;case"setPlayingChannels":t.data.channels.forEach(((t,e)=>{const s=this.channels[e];s&&(s.off=!t)}));break;case"speedUp":this.speedUp=t.data.speedUp,this.calcTickSpeed()}}postMessage(t){this.port.postMessage(t)}process(t,e,s){return this.ready&&this.playing?this.mix(e):this.emptyOutputBuffer(e),!0}emptyOutputBuffer(t){if(this.audioWorkletSupport){const e=t.length,s=t[0][0].length;for(let i=0;i<e;++i)for(let e=0;e<s;++e)t[i][0][e]=0}else{const e=t[0].length,s=t[0][0].length;for(let i=0;i<e;++i)for(let e=0;e<s;++e)t[0][i][e]=0}}init(){this.name="",this.samples=[],this.patterns=[],this.positions=[],this.songLength=0,this.channels||(this.channels=new Array(4)),this.maxSamples=0,this.bpm=125,this.speed=6,this.speedUp=1,this.position=0,this.pattern=0,this.row=0,this.samplesPerTick=0,this.filledSamples=0,this.ticks=0,this.newTick=!0,this.rowRepeat=0,this.rowJump=-1,this.skipPattern=!1,this.jumpPattern=-1,this.buffer=null,this.started=!1,this.ready=!1,this.playing=!1}resetValues(){this.started=!1,this.position=0,this.row=0,this.ticks=0,this.filledSamples=0,this.speed=6,this.newTick=!0,this.rowRepeat=0,this.rowJump=-1,this.skipPattern=!1,this.jumpPattern=-1,this.createChannels(),this.decodeRow()}createChannels(){for(let e=0;e<this.channels.length;++e){var t={sample:-1,samplePos:0,period:0,volume:64,slideTo:-1,slideSpeed:0,delay:0,vform:0,vdepth:0,vspeed:0,vpos:0,loopInitiated:!1,id:e,cmd:0};this.channels[e]?Object.assign(this.channels[e],t):this.channels[e]=t}}prepareModule(t){this.ready=!1,this.init(),this.buffer=t,this.name=BinUtils.readAscii(this.buffer,20),this.getInstruments(),this.getPatternData(),this.getSampleData(),this.calcTickSpeed(),this.createChannels(),this.resetValues(),this.ready=!0,this.postMessage({message:"moduleLoaded",data:{samples:this.samples,title:this.name,length:this.buffer.byteLength,positions:this.positions.length,patterns:this.patterns.length}})}detectMaxSamples(){const t=BinUtils.readAscii(this.buffer,4,1080);this.maxSamples=t.match("M.K.")?31:15,15===this.maxSamples?this.patternOffset=600:this.patternOffset=1084}calcTickSpeed(){this.samplesPerTick=60*this.mixingRate/(this.bpm*this.speedUp)/24}mix(t){const e=this.audioWorkletSupport&&t[0][0].length||t[0][0].length;for(let s=0;s<e;++s){let e=0;this.audioWorkletSupport?(t[0][0][s]=0,t[1][0][s]=0,t[2][0][s]=0,t[3][0][s]=0):(t[0][0][s]=0,t[0][1][s]=0),this.tick();for(let i=0;i<this.channels.length;++i){const a=this.channels[i];e^=1&i;const o=this.audioWorkletSupport?t[i][0]:t[0][e];if(this.newTick&&a.cmd&&this.executeEffect(a),!a.off&&a.period&&a.sample>-1&&!a.done&&this.ticks>=a.delay){const t=this.samples[a.sample];o[s]+=t.data[Math.floor(a.samplePos)]*a.volume/64;const e=7093789.2/(2*a.period*this.mixingRate);a.samplePos+=e,a.done||(t.repeatLength||t.repeatStart?a.samplePos>=t.repeatStart+t.repeatLength&&(a.samplePos=t.repeatStart):a.samplePos>t.length&&(a.samplePos=0,a.done=!0))}}this.filledSamples++,this.newTick=!1}}tick(){this.filledSamples>this.samplesPerTick&&(this.newTick=!0,this.ticks++,this.filledSamples=0,this.ticks>this.speed-1&&(this.ticks=0,this.rowRepeat<=0&&this.row++,(this.row>63||this.skipPattern)&&(this.skipPattern=!1,this.jumpPattern>-1?(this.position=this.jumpPattern,this.jumpPattern=-1,this.getNextPattern()):this.getNextPattern(!0)),this.rowJump>-1&&(this.row=this.rowJump,this.rowJump=-1),this.row>63&&(this.row=0),this.decodeRow()))}getNextPattern(t){t&&this.position++,this.position>this.positions.length-1&&(this.filledSamples,this.position=0);for(let t=0;t<this.channels.length;++t)this.channels[t].loopInitiated=!1;this.pattern=this.positions[this.position]}decodeRow(){this.started||(this.started=!0,this.getNextPattern());const t=this.patterns[this.pattern],e=new Uint8Array(t,16*this.row,16);for(let t=0;t<this.channels.length;++t){const s=4*t,i=(15&e[s])<<8|e[1+s],a=(240&e[s]|e[2+s]>>4)-1,o=15&e[2+s],h=e[3+s],r=this.channels[t];r.delay=0,o?14===o?(r.cmd=224+(h>>4),r.data=15&h):(r.cmd=o,r.data=h):r.cmd=0,a>-1&&(3!==r.cmd&&5!==r.cmd&&(r.samplePos=0),r.done=!1,r.sample=a,r.volume=this.samples[a].volume),i&&(r.done=!1,3!==r.cmd&&5!==r.cmd?(r.period=i,r.samplePos=0):r.slideTo=i)}}executeEffect(t){try{Effects[t.cmd](this,t)}catch(e){console.warn(`effect not implemented: ${t.cmd.toString(16).padStart(2,"0")}/${t.data.toString(16).padStart(2,"0")}`)}}getInstruments(){this.detectMaxSamples(),this.samples=new Array;let t=20;const e=new Uint8Array(this.buffer);for(let s=0;s<this.maxSamples;++s){const s={name:BinUtils.readAscii(this.buffer,22,t),length:2*BinUtils.readWord(this.buffer,t+22),fintune:240&e[t+24],volume:e[t+25],repeatStart:2*BinUtils.readWord(this.buffer,t+26),repeatLength:2*BinUtils.readWord(this.buffer,t+28),data:null};2===s.repeatLength&&(s.repeatLength=0,2===s.length&&(s.length=0)),s.repeatLength>s.length&&(s.repeatLength=0,s.repeatStart=0),this.samples.push(s),t+=30}}getPatternData(){const t=15===this.maxSamples?470:950,e=new Uint8Array(this.buffer,t);this.songLength=e[0];let s=2,i=0;for(let t=0;t<this.songLength;++t){const a=e[s+t];this.positions.push(a),a>i&&(i=a)}s=this.patternOffset;for(let t=0;t<=i;++t)this.patterns.push(this.buffer.slice(s,s+this.patternLength)),s+=this.patternLength}getSampleData(){let t=this.patternOffset+this.patterns.length*this.patternLength;for(let e=0;e<this.samples.length;++e){const s=this.samples[e].length,i=new Float32Array(s),a=t+s>this.buffer.byteLength?this.buffer.byteLength-t:s,o=new Int8Array(this.buffer,t,a);for(let t=0;t<s;++t)i[t]=o[t]/128;this.samples[e].data=i,t+=a}}toggleLowPass(t){this.postMessage({message:"toggleLowPass",data:{activate:t}})}}registerProcessor("mod-processor",PTModuleProcessor);const Effects={1(t,e){t.ticks&&(e.period-=e.data,e.period<113&&(e.period=113))},2(t,e){t.ticks&&(e.period+=e.data,e.period>856&&(e.period=856))},3(t,e,s){t.ticks?e.slideTo&&t.ticks&&(e.period<e.slideTo?(e.period+=e.slideSpeed,e.period>e.slideTo&&(e.period=e.slideTo)):e.period>e.slideTo&&(e.period-=e.slideSpeed,e.period<e.slideTo&&(e.period=e.slideTo))):!s&&e.data&&(e.slideSpeed=e.data)},4(t,e){if(!t.ticks){var s=15&e.data,i=(240&e.data)>>4;i&&s&&(e.vdepth=s,e.vspeed=i),e.vform>3&&(e.vpos=0)}const a=waveForms[3&e.vform];e.period+=e.vdepth*a[e.vpos]/63,e.vpos+=e.vspeed,e.vpos>63&&(e.vpos=e.vpos-64)},5(t,e){this[3](t,e),this[10](t,e)},6(t,e){this[4](t,e),this[10](t,e)},9(t,e){t.ticks||(e.samplePos=256*e.data)},10(t,e){if(t.ticks){let t=e.data>>4,s=15&e.data;s?t||(e.volume-=s):e.volume+=t,e.volume>63?e.volume=63:e.volume<0&&(e.volume=0)}},11(t,e){e.data>=0&&e.data<=t.patterns.length-1&&(t.skipPattern=!0,t.jumpPattern=e.data,t.rowJump=0)},12(t,e){t.ticks||(e.volume=e.data,e.volume>63&&(e.volume=63))},13(t,e){t.ticks||(t.rowJump=10*((240&e.data)>>4)+(15&e.data),t.skipPattern=!0)},224(t,e){t.ticks||t.toggleLowPass(!!e.data)},228(t,e){t.ticks},230(t,e){t.ticks||(0===e.data?e.loopInitiated?e.loops===e.loopCount&&(e.loopInitiated=!1):(e.loopInitiated=!0,e.loopStart=t.row,e.loopCount=0):e.loopInitiated&&(t.rowJump=e.loopStart,e.loopCount?e.loops++:(e.loopCount=e.data,e.loops=1)))},233(t,e){(t.ticks+1)%e.data||(e.samplePos=0,e.done=!1)},234(t,e){t.ticks||(e.volume+=e.data,e.volume>63&&(e.volume=63))},235(t,e){t.ticks||(e.volume-=e.data,e.volume<0&&(e.volume=0))},237(t,e){t.ticks||(e.delay=e.data)},238(t,e){t.ticks||(t.rowRepeat?t.rowRepeat&&t.rowRepeat--:t.rowRepeat=e.data)},15(t,e){t.ticks||(e.data<32?t.speed=e.data:(t.bpm=e.data,t.calcTickSpeed()))}};